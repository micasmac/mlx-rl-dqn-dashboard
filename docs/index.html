<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLX DQN Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.8em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .algorithm-badge {
            display: inline-block;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.4em;
            font-weight: bold;
            margin-left: 15px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.2);
        }
        .stat-value {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }
        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        @media (max-width: 1024px) {
            .chart-grid-3 {
                grid-template-columns: 1fr 1fr;
            }
        }
        @media (max-width: 768px) {
            .chart-grid, .chart-grid-3 {
                grid-template-columns: 1fr;
            }
        }
        .loading {
            text-align: center;
            font-size: 1.2em;
            margin: 50px 0;
        }
        .timestamp {
            text-align: center;
            margin-top: 20px;
            opacity: 0.8;
            font-style: italic;
        }
        .config-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .config-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
        }
        .config-item strong {
            color: #ffd700;
        }
        .error-message {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .performance-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .good { background: rgba(76, 175, 80, 0.3); }
        .fair { background: rgba(255, 193, 7, 0.3); }
        .poor { background: rgba(244, 67, 54, 0.3); }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† MLX DQN Dashboard <span class="algorithm-badge">DEEP Q-NETWORK</span></h1>
        
        <div id="loading" class="loading">
            Loading DQN training results...
        </div>
        
        <div id="error" class="error-message" style="display: none;">
            <h3>‚ö†Ô∏è Could not load training results</h3>
            <p>Make sure the GitHub Actions workflow has completed successfully and generated the results.</p>
        </div>
        
        <div id="content" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="avgReward">-</div>
                    <div class="stat-label">Average Reward</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="maxReward">-</div>
                    <div class="stat-label">Max Reward</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalEpisodes">-</div>
                    <div class="stat-label">Episodes Trained</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTimesteps">-</div>
                    <div class="stat-label">Total Timesteps</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgLoss">-</div>
                    <div class="stat-label">Average Loss</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="finalEpsilon">-</div>
                    <div class="stat-label">Final Epsilon</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgSPS">-</div>
                    <div class="stat-label">Avg SPS</div>
                </div>
            </div>
            
            <div class="chart-container">
                <div id="rewardChart"></div>
            </div>
            
            <div class="chart-grid">
                <div class="chart-container">
                    <div id="lossChart"></div>
                </div>
                <div class="chart-container">
                    <div id="epsilonChart"></div>
                </div>
            </div>
            
            <div class="chart-grid-3">
                <div class="chart-container">
                    <div id="episodeLengthChart"></div>
                </div>
                <div class="chart-container">
                    <div id="spsChart"></div>
                </div>
                <div class="chart-container">
                    <div id="learningProgressChart"></div>
                </div>
            </div>
            
            <div class="config-section">
                <h3>üîß DQN Configuration</h3>
                <div id="configGrid" class="config-grid">
                    <!-- Configuration items will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="timestamp">
                Last updated: <span id="lastUpdate">-</span>
            </div>
        </div>
    </div>

    <script>
        function getPerformanceIndicator(reward, environment) {
            // Performance thresholds for different environments
            const thresholds = {
                'CartPole-v1': { good: 450, fair: 200 },
                'LunarLander-v2': { good: 200, fair: 0 },
                'default': { good: 400, fair: 150 }
            };
            
            const thresh = thresholds[environment] || thresholds['default'];
            
            if (reward >= thresh.good) return 'good';
            if (reward >= thresh.fair) return 'fair';
            return 'poor';
        }

        async function loadResults() {
            try {
                const response = await fetch('results/latest_run.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Update stats with performance indicators
                const envName = data.config?.env_id || 'Unknown';
                const performanceClass = getPerformanceIndicator(data.avg_reward, envName);
                
                document.getElementById('avgReward').innerHTML = 
                    data.avg_reward.toFixed(2) + 
                    `<span class="performance-indicator ${performanceClass}">${performanceClass.toUpperCase()}</span>`;
                document.getElementById('maxReward').textContent = data.max_reward.toFixed(2);
                document.getElementById('totalEpisodes').textContent = data.episodes;
                document.getElementById('totalTimesteps').textContent = data.total_timesteps?.toLocaleString() || 'N/A';
                document.getElementById('avgLoss').textContent = data.avg_loss.toFixed(4);
                document.getElementById('finalEpsilon').textContent = data.final_epsilon?.toFixed(3) || 'N/A';
                document.getElementById('avgSPS').textContent = data.avg_sps?.toFixed(0) || 'N/A';
                document.getElementById('lastUpdate').textContent = new Date(data.timestamp).toLocaleString();
                
                // Plot episode rewards with moving average
                const rewardTraces = [{
                    x: Array.from({length: data.episode_rewards.length}, (_, i) => i + 1),
                    y: data.episode_rewards,
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Episode Reward',
                    marker: {color: 'rgba(135, 206, 250, 0.6)', size: 4},
                    opacity: 0.6
                }];
                
                if (data.moving_avg_rewards && data.moving_avg_rewards.length > 0) {
                    rewardTraces.push({
                        x: Array.from({length: data.moving_avg_rewards.length}, (_, i) => i + 1),
                        y: data.moving_avg_rewards,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Moving Average (100 episodes)',
                        line: {color: '#00ff88', width: 3}
                    });
                }
                
                Plotly.newPlot('rewardChart', rewardTraces, {
                    title: {
                        text: `Training Progress - Episode Rewards (${envName})`,
                        font: {color: 'white', size: 20}
                    },
                    xaxis: {
                        title: 'Episode',
                        color: 'white',
                        gridcolor: 'rgba(255,255,255,0.2)'
                    },
                    yaxis: {
                        title: 'Reward',
                        color: 'white',
                        gridcolor: 'rgba(255,255,255,0.2)'
                    },
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    font: {color: 'white'},
                    legend: {
                        font: {color: 'white'}
                    }
                });
                
                // Plot training loss
                if (data.losses && data.losses.length > 0) {
                    const lossTrace = {
                        x: Array.from({length: data.losses.length}, (_, i) => i + 1),
                        y: data.losses,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Training Loss',
                        line: {color: '#ff6b6b', width: 2}
                    };
                    
                    Plotly.newPlot('lossChart', [lossTrace], {
                        title: {
                            text: 'Training Loss Over Time',
                            font: {color: 'white', size: 18}
                        },
                        xaxis: {
                            title: 'Training Step',
                            color: 'white',
                            gridcolor: 'rgba(255,255,255,0.2)'
                        },
                        yaxis: {
                            title: 'Loss',
                            color: 'white',
                            gridcolor: 'rgba(255,255,255,0.2)'
                        },
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        font: {color: 'white'}
                    });
                }
                
                // Plot epsilon decay
                if (data.epsilon_values && data.epsilon_values.length > 0) {
                    const epsilonTrace = {
                        x: Array.from({length: data.epsilon_values.length}, (_, i) => i * 1000),
                        y: data.epsilon_values,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Epsilon',
                        line: {color: '#4CAF50', width: 3},
                        marker: {color: '#4CAF50', size: 6}
                    };
                    
                    Plotly.newPlot('epsilonChart', [epsilonTrace], {
                        title: {
                            text: 'Epsilon Decay (Exploration)',
                            font: {color: 'white', size: 18}
                        },
                        xaxis: {
                            title: 'Training Step',
                            color: 'white',
                            gridcolor: 'rgba(255,255,255,0.2)'
                        },
                        yaxis: {
                            title: 'Epsilon',
                            color: 'white',
                            gridcolor: 'rgba(255,255,255,0.2)'
                        },
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        font: {color: 'white'}
                    });
                }
                
                // Plot episode lengths
                if (data.episode_lengths && data.episode_lengths.length > 0) {
                    const lengthTrace = {
                        x: Array.from({length: data.episode_lengths.length}, (_, i) => i + 1),
                        y: data.episode_lengths,
                        type: 'scatter',
                        mode: 'markers',
                        name: 'Episode Length',
                        marker: {color: '#FF9800', size: 4, opacity: 0.6}
                    };
                    
                    Plotly.newPlot('episodeLengthChart', [lengthTrace], {
                        title: {
                            text: 'Episode Lengths',
                            font: {color: 'white', size: 18}
                        },
                        xaxis: {
                            title: 'Episode',
                            color: 'white',
                            gridcolor: 'rgba(255,255,255,0.2)'
                        },
                        yaxis: {
                            title: 'Steps',
                            color: 'white',
                            gridcolor: 'rgba(255,255,255,0.2)'
                        },
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        font: {color: 'white'}
                    });
                }
                
                // Plot SPS (Steps Per Second)
                if (data.sps_values && data.sps_values.length > 0) {
                    const spsTrace = {
                        x: Array.from({length: data.sps_values.length}, (_, i) => i + 1),
                        y: data.sps_values,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'SPS',
                        line: {color: '#9C27B0', width: 2},
                        marker: {color: '#9C27B0', size: 6}
                    };
                    
                    Plotly.newPlot('spsChart', [spsTrace], {
                        title: {
                            text: 'Training Speed (SPS)',
                            font: {color: 'white', size: 18}
                        },
                        xaxis: {
                            title: 'Measurement Point',
                            color: 'white',
                            gridcolor: 'rgba(255,255,255,0.2)'
                        },
                        yaxis: {
                            title: 'Steps/Second',
                            color: 'white',
                            gridcolor: 'rgba(255,255,255,0.2)'
                        },
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        font: {color: 'white'}
                    });
                }
                
                // Learning progress comparison
                if (data.episode_rewards.length >= 100) {
                    const first50 = data.episode_rewards.slice(0, 50).reduce((a, b) => a + b, 0) / 50;
                    const last50 = data.episode_rewards.slice(-50).reduce((a, b) => a + b, 0) / 50;
                    
                    const progressTrace = {
                        x: ['First 50 Episodes', 'Last 50 Episodes'],
                        y: [first50, last50],
                        type: 'bar',
                        marker: {
                            color: ['rgba(255, 99, 132, 0.6)', 'rgba(75, 192, 192, 0.6)'],
                            line: {
                                color: ['rgba(255, 99, 132, 1)', 'rgba(75, 192, 192, 1)'],
                                width: 2
                            }
                        }
                    };
                    
                    Plotly.newPlot('learningProgressChart', [progressTrace], {
                        title: {
                            text: `Learning Progress<br><sub>Improvement: ${(last50 - first50).toFixed(1)}</sub>`,
                            font: {color: 'white', size: 18}
                        },
                        xaxis: {
                            color: 'white',
                            gridcolor: 'rgba(255,255,255,0.2)'
                        },
                        yaxis: {
                            title: 'Average Reward',
                            color: 'white',
                            gridcolor: 'rgba(255,255,255,0.2)'
                        },
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        font: {color: 'white'}
                    });
                }
                
                // Populate configuration
                const configGrid = document.getElementById('configGrid');
                configGrid.innerHTML = '';
                
                const configItems = [
                    { label: 'Environment', value: data.config.env_id || 'N/A' },
                    { label: 'Learning Rate', value: data.config.learning_rate || 'N/A' },
                    { label: 'Batch Size', value: data.config.batch_size || 'N/A' },
                    { label: 'Buffer Size', value: (data.config.buffer_size || 0).toLocaleString() },
                    { label: 'Gamma (Discount)', value: data.config.gamma || 'N/A' },
                    { label: 'Target Network Freq', value: (data.config.target_network_frequency || 0).toLocaleString() },
                    { label: 'Train Frequency', value: data.config.train_frequency || 'N/A' },
                    { label: 'Learning Starts', value: (data.config.learning_starts || 0).toLocaleString() },
                    { label: 'Exploration Fraction', value: data.config.exploration_fraction || 'N/A' },
                    { label: 'Start Epsilon', value: data.config.start_e || 'N/A' },
                    { label: 'End Epsilon', value: data.config.end_e || 'N/A' },
                    { label: 'Random Seed', value: data.config.seed || 'N/A' }
                ];
                
                configItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'config-item';
                    div.innerHTML = `<strong>${item.label}:</strong> ${item.value}`;
                    configGrid.appendChild(div);
                });
                
                // Show content, hide loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading results:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = `
                    <h3>‚ö†Ô∏è Could not load training results</h3>
                    <p>Error: ${error.message}</p>
                    <p><small>Make sure the GitHub Actions workflow has completed successfully</small></p>
                `;
            }
        }
        
        // Load results when page loads
        loadResults();
        
        // Auto-refresh every 5 minutes
        setInterval(loadResults, 5 * 60 * 1000);
    </script>
</body>
</html>
